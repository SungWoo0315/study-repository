# 2021년 9월 13일 [83일차]

## # 오전수업
----
### `09:30~`

<이번주 목표>   

파일 업로드 기능 구현.    

게시판 관련 문제 풀면서 복습.    

#

<파일 업로드>   

게시판 입력 수정.   

DB 저장,  

파일까지 업로드 되어야 한다.  

데이터베이스에 안들어가면,  

파일 업로드도 안되어야 한다.  

즉, 파일 업로드하고 DB 연동이 같이 움직여야 한다.   

#

오후부터는 게시판 소스 중심 문제 정리.  

#

다음주는 리엑트 나갈 예정.   

#

<진도>  
<파일업로드>   

지금까지는,  
웹서버쪽으로 문자데이터를 DB에 넣은것이다.  

파일업로드는,  
파일을 서버로 올린다.  
서버로 올라간 파일이 특정폴더에 저장되어야 한다.  

올라간 파일의 이름은,  
규칙적이고 중복되지 않게 이름이 바뀌어서 저장되어야 한다.  

그 후,    
특정 폴더에 저장되어야 한다.  
그리고, DB쪽에 파일이름이 저장된다.  

#

SQL 게이트 열어서,  

이미지가 들어갈 컬럼 추가.   

컬럼명은 `PIC`  

데이터 유형 `varchar2`    

이미지는 선택사항,  제약조건 없이,   
> 이미지가 반드시 들어가야하면, 제약조건이 들어가야 한다.    

#

`boardRegForm.jsp` 에서,    

파일 업로드 버튼 및 기능 구현.     

상당부분 코드 변경 예정.   

이미지 입력양식 추가.  

```jsp
<form name="boardRegForm" method="POST" action="/boardRegProc.do" enctype="multipart/form-data">


<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

<!-- ====================================== -->
<!-- 위 코드도 추가해야 한다 -->
<!-- 하단 코드는 위치 확인용 -->
<!-- ====================================== -->

<tr>
    <th bgcolor="${thBgColor}">내용</th>
    <td>
    <textarea name="content" class="content" rows="13" cols="40"  maxlength="300"></textarea>
    </td>
</tr>

<!-- ====================================== -->
<!-- 위 쪽 코드는 위치 확인용. -->
<!-- 아래 코드를 추가한 것이다. -->
<!-- ====================================== -->

<tr>
    <th bgcolor="${thBgColor}">이미지</th>
    <td>
    <input type="file" name="img" class="img">
    </td>
</tr>
```
> 파일업로드 입력양식이 들어가면,  
> 상단의 form 태그 안에,  
> 반드시!! `enctype="multipart/form-data"` 코드가 추가되어야 한다.     

```javascript
function checkBoardRegForm(){
    // ------------------------------------
    // "정말 등록 하시겠습니까?" 라고 물어보기
    // ------------------------------------
    if(confirm("정말 등록 하시겠습니까??")==false) {return;}

// ===================================
// 위 코드는 위치 확인용.  
// 아래 코드를 추가해야함.  
// ===================================

    // ------------------------------------
    // form 태그에 파일업로드 전송 관련 설정하기
    // ------------------------------------
    document.boardRegForm.enctype="multipart/form-data";
```
> form 태그안에 `enctype="multipart/form-data"` 써주지 않고 작동하게 하려면,  
> 클릭 했을 시 작동하는 함수안에다가 위 코드를 넣어야 한다.   


현재 `ajax` 형식 에서는 파일업로드가 되지 않는다.    

`ajax` 의,  

`,data     : $("[name=boardRegForm]").serialize() ` 부분을 지우고 새로운 코드를 작성해야 한다.  

```javascript
$.ajax({

    // ----------------------------------------------------------
    // 서버쪽 호출 URL 주소 지정
    // ----------------------------------------------------------
    url       : "/boardRegProc.do"
    // ----------------------------------------------------------
    // form 태그 안의 입력양식 데이터 즉, 파라미터값을 보내는 방법 지정
    // ----------------------------------------------------------
    ,type     : "post"

// =====================================
// 위쪽코드는 위치 확인용.
// 아래 코드가 추가되었음.  
// =====================================
    
    // ----------------------------------------------------------
    // 파일업로드를 위한 설정.    
    // ----------------------------------------------------------
    ,processData    :    false
    ,contentType    :    false
    ,data           :    new FormData(  $("[name=boardRegForm").get(0)  )


    // 아래코드는 입력양식의 name 값과 value 값만 보내지는것. 위쪽 코드는 파일까지 되는 코드.   
    // ,data     : $("[name=boardRegForm]").serialize()
```
> 원본 파일에서 주석도 붙여주면 좋다.  

#

시중의 책에는 파일업로드 방식이 두가지가 있다.   

그중 하나가 `ajax` 이용한 업로드 방식.   

#

----
### `10:30~`

`BoardDTO` 쪽에 `PIC컬럼이 들어갔으므로 `

`private String pic;` 추가하고, getter setter  해주어야 한다.  

#

`BoardController.java` 에서,    

`"/boardRegProc.do"` 위치,  

```java
@RequestMapping( 
    value="/boardRegProc.do"
    ,method = RequestMethod.POST
    ,produces = "application/json;charset=UTF8"
)
@ResponseBody
public Map<String, String> insertBoard( 
    // **********************************************
    // 파라미터값을 저장할 [BoardDTO 객체]를 매개변수로 선언
    // **********************************************
        // [파라미터명]과 [BoardDTO 객체]의 [속성변수명]이 같으면
        // setter 메소드가 작동되어 [파라미터값]이 [속성변수]에 저장된다.
        // [속성변수명]에 대응하는 [파라미터명]이 없으면 setter 메소드가 작동되지 않는다.
        // [속성변수명]에 대응하는 [파라미터명]이 있는데 [파라미터값]이 없으면
        // [속성변수]의 자료형에 관계없이 무조건 null 값이 저장된다.
        // 이때 [속성변수]의 자료형이 기본형일 경우 null 값이 저장될 수 없어 에러가 발생한다. 
        // 이런 에러를 피하려면 파라미터값이 기본형이거나 속성변수의 자료형을 String 으로 해야한다.
        // 이런 에러가 발생하면 메소드안의 실행구문은 하나도 실행되지 않음에 주의한다.
        // 매개변수로 들어온 [DTO 객체]는 이 메소드가 끝난 후 호출되는 JSP 페이지로 그대로 이동한다.
        // 즉, HttpServletRequest 객체에 boardDTO 라는 키값명으로 저장된다.  

    BoardDTO boardDTO

// =================================
// 위쪽은 위치확인용 코드.
// 아래쪽 코드를 추가해야 한다.  
// =================================



    // **********************************************
    // <input type=file name=pic> 입력양식의 파일이 저장된 MultipartFile 객체 저장 매개변수 선언.
    // <주의> 업로드된 파일이 없어도 MultipartFile 객체는 생성되어 들어온다. 
    // **********************************************
    ,@RequestParam("img") MultipartFile multi



// =================================
// 위쪽 코드를 추가해야 한다.  
// 아래쪽은 위치확인용 코드.
// =================================

    // **********************************************
    // Error 객체를 관리하는 BindingResult 객체가 저장되어 들어오는 매개변수 bindingResult 선언
    // **********************************************
    , BindingResult bindingResult


)
```

#

트랜잭션이 포함된 파일업로드가 되어야 한다.    

#

올린 파일의 확장자를 검사해주어야 한다.        

올라가는 이미지파일의 용량제한이 필요하다.        

#

위 에서 추가한 매개변수 코드 다음 로직부분,  

`BoardController.java` 에 이어서,  

```java 
    // **********************************************
    // <input type=file name=img> 입력양식의 파일이 저장된 MultipartFile 객체 저장 매개변수 선언.
    // <주의> 업로드된 파일이 없어도 MultipartFile 객체는 생성되어 들어온다. 
    // **********************************************
    ,@RequestParam("img") MultipartFile multi

    // **********************************************
    // Error 객체를 관리하는 BindingResult 객체가 저장되어 들어오는 매개변수 bindingResult 선언
    // **********************************************
    , BindingResult bindingResult


// ====================
// 위코드는 위치 확인용 
// 아래코드 추가.  
// ====================

){
    // **********************************************
    // 업로드 파일의 크기와 확장자 체크하기.
    // **********************************************

    // 만약에 업로드된 파일이 있으면
    if( multi.isEmpty()==false ){
  
        // 만약에 업로드된 파일의 크기가 1000000 byte(=1000kb) 보다 크면 
        if( multi.getSize()>1000000){
            Map<String,String> map = new HashMap<String,String>();
            map.put("boardRegCnt", "0");
            map.put("msg", "업로드 파일이 1000kb 보다 크면 업로드 할 수 없습니다.");
            return map;
        }

        // 만약에 업로드된 파일의 확장자가 이미지 확장자가 아니면 
        String fileName = multi.getName();
        if( fileName.endsWith(".jpg")==false && fileName.endsWith(".gif")==false && fileName.endsWith(".png")==false ){
            Map<String,String> map = new HashMap<String,String>();
            map.put("boardRegCnt", "0");
            map.put("msg", "이미지 파일 형식이 아닙니다.");
            return map;
        }
    }
```
> `indexOf()` 쓰임 공부하기.    
> 파일명 중간에 `.jpg` 가 나올수도 있으므로,  
> `indexOf()` 는 쓰면 안된다.  
> 맨 뒤에것이 확장자여야 하므로.  

> `endsWith()` 를 써주어야 한다.   
> 마지막 문자를 골라내어 값이 일치하면 true 리턴하는 java String 객체의 메소드이다.  


#

(입) 입사시험.  

- return 의 용도.  

  1. 메소드 중단.  

  2. 오른쪽에 값이 있으면 호출한쪽으로 전달.  


- String 객체의 메소드.

  리턴값, 매개변수 암기하기.

#

입력이 안되면 파일업로드도 안되어야 한다.  
DB 에 트랜잭션, 파일업로드도 같이 되어야 한다.  

#

`BoardController.java` 에서,  

매개변수 추가.  

```java
boardRegCnt = this.boardService.insertBoard(boardDTO, multi); 
```
> 

#

`BoardService.java`   

`BoardServiceImpl.java`

에서도,    

`insertBoard()` 메서드 매개변수에,  

`MultipartFile multi` 매개변수를 추가해주어야 한다.  

#

----
### `11:30~`

`BoardServiceImpl.java` 에서,  

파일 업로드를 DB 연동 전에 할것인지?    
파일 업로드를 DB 연동 후에 할것인지?     

파일 업로드는 트랜잭션에 포함되지 않기 때문에.  

파일 업로드를 DB 연동 전에 하면, 파일업로드는 성공해서 올라가는데, DB 쪽에서 에러가 터지면 파일만 이미 올라가버리기 때문에,   

### **DB 연동 후에 파일 업로드를 수행해야 한다.**

`BoardServiceImpl` 에서 예외가 터지면,  

트랜잭션이 걸려 있으므로 모든작업이취소 된다.    

#



















----
### `12:30~`








----
### `13:20~`

  - 점심시간.

---
---

## # 오후수업

---
### `14:30~`










---
### `15:30~`









----
### `16:30~`








----
### `17:30~`








----
### `18:30~`
